{% extends "base.html" %}
{% block content %}
  <h1>Prediction Results</h1>
  {% if predictions and predictions|length > 0 %}
    <!-- Insert your graph here, e.g., a bar chart of cluster assignments -->
    <canvas id="predictionChart"></canvas>
    <script src="/static/vendor/chart.js/Chart.min.js"></script>
    <script>
      var predictions = {{ predictions|tojson|safe }};
      // K-Means scatter plot: each point is a prediction, colored by cluster
      // Determine feature(s) used for KMeans
      let featureNames = [];
      if (predictions.length > 0 && predictions[0].input) {
        featureNames = Object.keys(predictions[0].input);
      }
      // Assign a color for each cluster
      const clusterColors = [
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 99, 132, 0.8)',
        'rgba(255, 206, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)'
      ];
      // Group points by cluster
      const clusterPoints = {};
      predictions.forEach(p => {
        let cluster = p.prediction;
        if (Array.isArray(cluster)) cluster = cluster[0];
        if (!clusterPoints[cluster]) clusterPoints[cluster] = [];
        // For 1D, use x=feature, y=0; for 2D, use x=feature1, y=feature2
        let x = 0, y = 0;
        if (featureNames.length === 1) {
          x = parseFloat(p.input[featureNames[0]]);
          y = 0;
        } else if (featureNames.length >= 2) {
          x = parseFloat(p.input[featureNames[0]]);
          y = parseFloat(p.input[featureNames[1]]);
        }
        clusterPoints[cluster].push({x, y});
      });
      // Prepare datasets for Chart.js
      const datasets = Object.keys(clusterPoints).map((cluster, idx) => ({
        label: cluster,
        data: clusterPoints[cluster],
        backgroundColor: clusterColors[idx % clusterColors.length],
        pointRadius: 6,
        pointHoverRadius: 8
      }));
      const ctx = document.getElementById('predictionChart').getContext('2d');
      if (datasets.length > 0) {
        new Chart(ctx, {
          type: 'scatter',
          data: { datasets },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true },
              title: {
                display: true,
                text: featureNames.length === 1
                  ? `K-Means Clusters by ${featureNames[0]}`
                  : `K-Means Clusters by ${featureNames[0]} and ${featureNames[1]}`
              }
            },
            scales: {
              x: {
                title: { display: true, text: featureNames[0] || 'Feature' }
              },
              y: {
                title: { display: true, text: featureNames[1] || '' },
                beginAtZero: featureNames.length === 1
              }
            }
          }
        });
      }
    </script>
  {% else %}
    <div class="alert alert-info">
      No predictions yet. Please make a prediction in the Train page.
    </div>
  {% endif %}
{% endblock %}
